<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #all{
            display: flex;
            flex-direction: column;
            margin: auto;
        }
        #canvas{
            margin: auto;
            background-color: #9ff;
            border: 5px ridge #ccc;
        }
        #menu{
            margin: 1px auto 0 auto;
            display: flex;
            flex-direction: column;
            width: 340px;
            height: 500px;
            overflow-y: scroll;
            /* background-color: aqua; */
        }
        .menuLevel{
            margin: auto;
            display: flex;
            border: 5px ridge #ccc;
            margin: 2px auto 0 auto;
        }
        .imgLevel{
            background-color: #000;
        }
        .menuLevelInner{
            width: 220px;
        }
        .textLevel{
            /* test */
            padding-left: 5px;
            background-color: #fdf;
        }
        .buttonLevel{
            height: 24px;
            margin: 0 0 0 auto;
            padding: 4px 5px 0 0;
            text-align: right;
            border: 2px outset;
            font-size:14px;
            cursor: pointer;
        }
        .buttonLevel:active{
            border: 2px inset;
        }

    </style>
</head>
<body>
    <div id="all">
        <canvas id="canvas" width="320px" height="200px"></canvas>
        <div id="menu">
            <!-- ここにメニューが入る -->
        </div>
    </div>
</body>
<script>

    const cvs = document.getElementById("canvas");
    const ctx = cvs.getContext('2d');
    let cvx = cvs.width;
    let cvy = cvs.height;
    const ctxm = [];
    const digit = ["","万","億","兆","京","垓","𥝱","穣","溝","澗","正","載","極","恒河沙","阿僧祇","那由他","不可思議","無量大数",""]
    const worker = ["test1","test2","test3","test4","test5","test6","test7","test8","test9","test10","test11","test12","test13","test14","test15","test16","test17","test18","test19","test20"]

    

    let autoSpeedSum = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
    let clickPoint = 0;
    let autoSpeedLevel = [];
    let timeCount = 0;
    let priceLevel = [[0,100,0]];//[最初の桁,最初の桁の数、次の桁の数]
    let workerSpeed = [[0,1,0],[0,10,0]];
    let myPrice = [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    
    
    //レベル帯作成
    const putMenu = () =>{
        const num = autoSpeedLevel.length;
        //レベル帯の配置場所作成
        let levelDiv = document.createElement("div");
        levelDiv.setAttribute("id", "level" + num);
        levelDiv.setAttribute("class", "menuLevel");

        //レベル帯のキャンバス作成
        let levelcvs = document.createElement("canvas");
        levelcvs.setAttribute("id","img" + num);
        levelcvs.setAttribute("class","imgLevel");
        levelcvs.setAttribute("width",80);
        levelcvs.setAttribute("height",80);
        ctxm.push(levelcvs.getContext('2d'));

        //レベル帯の中身作成
        let levelDivInner = document.createElement("div");
        levelDivInner.setAttribute("id", "levelInner" + num);
        levelDivInner.setAttribute("class", "menuLevelInner");

        //レベル帯のキャラ名表示作成
        let levelText1 = document.createElement("div");
        levelText1.setAttribute("id", "text1_" + num);
        levelText1.setAttribute("class", "textLevel");
        levelText1.innerHTML=worker[num];

        //レベル帯の文章表示作成
        let levelText2 = document.createElement("div");
        levelText2.setAttribute("id", "text2_" + num);
        levelText2.setAttribute("class", "textLevel");
        levelText2.innerText="🔓";

        //レベル帯の購入ボタン作成
        let levelButton = document.createElement("div");
        levelButton.setAttribute("id","button" + num);
        levelButton.setAttribute("class", "buttonLevel");
        levelButton.textContent = priceText(priceLevel[num]);
        let we = priceText(priceLevel[num]).length+1-String(priceLevel[num][1]).length/2-String(priceLevel[num][2]).length/2;
        levelButton.setAttribute("style", "width:"+Math.min(we*15,210)+"px")


        //設置
        levelDivInner.appendChild(levelText1);
        levelDivInner.appendChild(levelText2);
        levelDivInner.appendChild(levelButton);
        levelDiv.appendChild(levelcvs);
        levelDiv.appendChild(levelDivInner);
        document.querySelector("#menu").appendChild(levelDiv);
        clickButton("button" + num);
        autoSpeedLevel.push(0);
        priceLevel.push(nextLevel(priceLevel[priceLevel.length-1]));
    }

    //priceのテキスト
    const priceText = (price) =>{
        let karitext = "G"
        if(price[1]!==0){
            karitext = price[1] + digit[price[0]] + karitext; 
        }
        if(price[2]!==0){
            karitext = price[2] + digit[price[0]+1] + karitext; 
        }
        return karitext;
    }

    //初期スピードのセット
    const setSpeed = () =>{
        for(i=2;i<worker.length;i++){
            let n = [0,0,0];
            let num = 0;
            n[0] = workerSpeed[workerSpeed.length-1][0]
            n[1] = workerSpeed[workerSpeed.length-1][1]
            n[2] = workerSpeed[workerSpeed.length-1][2]
            num = (n[2]*10000+n[1])*i*i*i;
            if(num>99999999){
                n[0]++;
                num = Math.round(num/10000);
            }
            n[1] = Math.round(num%10000);
            n[2] = Math.floor(num/10000);
            workerSpeed.push(n)
        }
    }

    //次のレベルをセット
    const nextLevel = (price) =>{
        let p = [price[0],0,0]
        const n = autoSpeedLevel.length+1;
        let x = price[2]*10000+price[1];
        x = n*n*n*x
        if(x>99999999){
            p[0]++;
            x = Math.floor(x/10000);
        }
        p[1]=x%10000;
        p[2]=Math.floor(x/10000);
        return p;
    }

    //myPraceから減算する
    const subPrice = (price) =>{
        let myP = myPrice[price[0]+1] * 10000 + myPrice[price[0]];
        const subP = price[2]*10000+price[1];
        let n = 0;
        if(myP<subP){
            for(i=price[0]+2;i<myPrice.length;i++){
                if(myPrice[i]>0){
                    myPrice[i]--;
                    for(j=i-1;j>price[0]+1;j--){
                        myPrice[j]=9999;
                    }
                    myP += 100000000;
                    break;
                }
            }
        }
        n = myP-subP;
        myPrice[price[0]]=n%10000;
        myPrice[price[0]+1]=Math.floor(n/10000);
    }

    //myPriceを繰り上げする
    const advMyprice = () =>{
        for(i=0;i<myPrice.length-1;i++){
            if(myPrice[i]>9999){
                myPrice[i] -= 10000;
                myPrice[i+1]++;
            }
        }
    }

    //priceを繰り上げする
    const advprice = (price) =>{
        let num = price[2]*10000+price[1];
        let q=[price[0],price[1],price[2]]
        if(num>99999999){
            q[0]++;
            num = Math.floor(num/10000);
        }
        q[1] = Math.round(num%10000);
        q[2] = Math.floor(num/10000);
        return q;
    }

    //myPriceに加算する
    const addPrice = (price) =>{
        myPrice[price[0]] += price[1];
        myPrice[price[0]+1] += price[2];
        advMyprice();
        console.log(myPrice)
    }

    //mypriceのcanvas表示
    const displayMyprice = () =>{
        let n = [0,0,0]
        for(i=myPrice.length-1;i>0;i--){
            if(myPrice[i]>0){
                n[2]=myPrice[i];
                n[1]=myPrice[i-1];
                n[0]=i-1;
                break;
            }
        }
        if(n[0]==0&&n[1]==0&&n[2]==0){
            n[1]=myPrice[0];
        }
        ctx.clearRect(0, 0,cvx,cvy/8);
        
        ctx.fillStyle='#fff';
        ctx.fillRect(0,0,cvx,cvy/8);
        ctx.font = Math.max(cvy/10,10) + "px serif";
        ctx.fillStyle='#000';
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        ctx.fillText("所持金：" + priceText(n), cvx,cvy/16);
    }

    const mainAct = () =>{
        //画像の切り替え
        timeCount++;
        if(timeCount>=300){
            timeCount=0;
        }
        culSum();
        if(timeCount%1==0){
            for(i=0;i<myPrice.length;i++){
                myPrice[i] += autoSpeedSum[i];
            }
            advMyprice();
            displayMyprice();
        }

    }

    //現在のautoSpeedSumの計算
    const culSum = () =>{
        for(i=0;i<autoSpeedSum.length;i++){
            autoSpeedSum[i]=0
        }
        for(i=0;i<worker.length;i++){
            let n = [0,0,0];
            if(autoSpeedLevel[i]!==undefined){
                n[0] = workerSpeed[i][0]
                n[1] = workerSpeed[i][1]*autoSpeedLevel[i]
                n[2] = workerSpeed[i][2]*autoSpeedLevel[i]
                n = advprice[n];
                autoSpeedSum[n[0]] += n[1];
                autoSpeedSum[n[0]+1] += n[2];
            }
        }
    }//次回この辺でバグってる


    const clickButton = (n) =>{
        document.getElementById(n).addEventListener("click",function(){
            if(n.match(/^button[0-9]{1,}/)!==null){
                let num = Number(n.split("n")[1]);
                let checker = false;
                let needMoney = priceLevel[num][2]*10000+priceLevel[num][1]
                let haveMoney = 0;
                for(i=priceLevel[num][0]+2;i<myPrice.length;i++){
                    haveMoney += myPrice[i];
                }
                if(haveMoney>0){
                    checker = true;
                }else{
                    haveMoney = myPrice[priceLevel[num][0]+1]*10000+myPrice[priceLevel[num][0]];
                    if(haveMoney>=needMoney){
                        checker = true;
                    }
                }
                if(checker&&autoSpeedLevel[num]<100){
                    subPrice(priceLevel[num]);
                    if(autoSpeedLevel[num]===0&&num<worker.length-1){
                        putMenu()
                    }
                    autoSpeedLevel[num]++;
                    needMoney = (1+(autoSpeedLevel[num])*0.01)*needMoney;//レベルアップ処理
                    if(needMoney>99999999){
                        priceLevel[num][0]++;
                        needMoney = Math.round(needMoney/10000);
                    }
                    if(priceLevel[num][0]>16){
                        priceLevel[num][0]=17;
                        priceLevel[num][1]=9999;
                        priceLevel[num][2]=9999;
                        console.log(priceLevel[num]);
                    }
                    priceLevel[num][1]=Math.round(needMoney%10000);
                    priceLevel[num][2]=Math.floor(needMoney/10000);
                    if(autoSpeedLevel[num]==100){
                        document.getElementById("button" + num).textContent = "MAX!"
                    }else{
                        document.getElementById("button" + num).textContent = priceText(priceLevel[num]);
                    }
                    let we = priceText(priceLevel[num]).length+1-String(priceLevel[num][1]).length/2-String(priceLevel[num][2]).length/2;
                    document.getElementById("button" + num).setAttribute("style", "width:"+Math.min(we*15,210)+"px")
                    document.getElementById("text2_" + num).textContent="LEVEL:" + autoSpeedLevel[num]
                    displayMyprice();
                    //レベルアップの処理
                }
            }
        })
    }
    setSpeed();
    putMenu();


</script>
</html>